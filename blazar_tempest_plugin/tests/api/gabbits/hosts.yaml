fixtures:
    - AuthenticationFixture

defaults:
  request_headers:
    accept: application/json
    content-type: application/json
    X-Auth-Token: $ENVIRON['OS_TOKEN']

vars:
  - &compute_hypervisors $ENVIRON['COMPUTE_SERVICE']/v2.1/os-hypervisors
  - &reservation_hosts $ENVIRON['RESERVATION_SERVICE']/v1/os-hosts

tests:
- name: get host name
  GET: *compute_hypervisors
  status: 200

- name: post new host with too long extra capability
  POST: *reservation_hosts
  data:
      name: $HISTORY['get host name'].$RESPONSE['$.hypervisors[0].hypervisor_hostname']
      extra_capability_key_should_be_shorter_than_64_ABCDEFGHIJKLMNOPQRSTUVWXYZ: "foo"
  status: 400
  response_strings:
      - Extra capability key too long

- name: post new host
  POST: *reservation_hosts
  data:
      name: $HISTORY['get host name'].$RESPONSE['$.hypervisors[0].hypervisor_hostname']
  status: 201

- name: get new host
  GET: *reservation_hosts
  response_json_paths:
     $.hosts.`len`: 1

- name: delete new host
  DELETE: $ENVIRON['RESERVATION_SERVICE']/v1/os-hosts/$HISTORY['get new host'].$RESPONSE['$.hosts[0].id']
  status: 204

- name: get no host
  GET: *reservation_hosts
  response_json_paths:
     $.hosts.`len`: 0
